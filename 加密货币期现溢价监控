import streamlit as st
import pandas as pd
import time
import requests
import json
import os
from datetime import datetime, timedelta, timezone
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# é¡µé¢é…ç½®
st.set_page_config(
    page_title="åŠ å¯†è´§å¸è´¹ç‡ç›‘æ§ç³»ç»Ÿ",
    page_icon="ğŸ“ˆ",
    layout="wide",
    initial_sidebar_state="collapsed"  # é»˜è®¤æŠ˜å ä¾§è¾¹æ 
)

# åˆå§‹åŒ–ä¼šè¯çŠ¶æ€
if 'symbol' not in st.session_state:
    st.session_state.symbol = "BTCUSDT"
if 'timestamps' not in st.session_state:
    st.session_state.timestamps = []
    st.session_state.spot_prices = []
    st.session_state.futures_prices = []
    st.session_state.premiums = []
    st.session_state.funding_rates = []
    st.session_state.open_interest = []
    st.session_state.last_funding_rate = None
    st.session_state.running = False
    st.session_state.charts = [None, None, None]
    st.session_state.historical_data_loaded = False
    st.session_state.stats_data = None
    st.session_state.last_stats_update = None

# å¸¸é‡
UPDATE_INTERVAL = 10  # æ•°æ®æ›´æ–°é—´éš”ï¼ˆç§’ï¼‰
MAX_DATA_POINTS = 240  # æœ€å¤§æ•°æ®ç‚¹æ•°é‡ (4å°æ—¶ = 240åˆ†é’Ÿ)
HOURS_TO_DISPLAY = 4  # æ˜¾ç¤ºè¿‡å»å¤šå°‘å°æ—¶çš„æ•°æ®
STATS_FILE = "funding_rates_stats.json"  # ç»Ÿè®¡æ•°æ®æ–‡ä»¶


# è¯»å–ç»Ÿè®¡æ•°æ®
def load_stats_data():
    try:
        if os.path.exists(STATS_FILE):
            with open(STATS_FILE, 'r') as f:
                data = json.load(f)
                st.session_state.stats_data = data
                st.session_state.last_stats_update = datetime.now()
                return data
        return None
    except Exception as e:
        st.error(f"è¯»å–ç»Ÿè®¡æ•°æ®å‡ºé”™: {e}")
        return None


# è·å–ç°è´§ä»·æ ¼
def get_spot_price(symbol):
    try:
        url = "https://api.binance.com/api/v3/ticker/price"
        params = {"symbol": symbol}
        response = requests.get(url, params=params)
        response.raise_for_status()
        data = response.json()
        if "price" in data:
            return float(data["price"])
        else:
            st.error(f"æ— æ³•è·å–ç°è´§ä»·æ ¼: {data}")
            return None
    except Exception as e:
        st.error(f"è·å–ç°è´§ä»·æ ¼æ—¶å‡ºé”™: {e}")
        return None


# è·å–æœŸè´§ä»·æ ¼
def get_futures_price(symbol):
    try:
        url = "https://fapi.binance.com/fapi/v1/ticker/price"
        params = {"symbol": symbol}
        response = requests.get(url, params=params)
        response.raise_for_status()
        data = response.json()
        if "price" in data:
            return float(data["price"])
        else:
            st.error(f"æ— æ³•è·å–æœŸè´§ä»·æ ¼: {data}")
            return None
    except Exception as e:
        st.error(f"è·å–æœŸè´§ä»·æ ¼æ—¶å‡ºé”™: {e}")
        return None


# è·å–èµ„é‡‘è´¹ç‡
def get_funding_rate(symbol):
    try:
        url = "https://fapi.binance.com/fapi/v1/premiumIndex"
        params = {"symbol": symbol}
        response = requests.get(url, params=params)
        response.raise_for_status()
        data = response.json()
        if "lastFundingRate" in data:
            return float(data["lastFundingRate"])
        else:
            st.error(f"æ— æ³•è·å–èµ„é‡‘è´¹ç‡: {data}")
            return None
    except Exception as e:
        st.error(f"è·å–èµ„é‡‘è´¹ç‡æ—¶å‡ºé”™: {e}")
        return None


# è·å–æŒä»“é‡
def get_open_interest(symbol):
    try:
        url = "https://fapi.binance.com/fapi/v1/openInterest"
        params = {"symbol": symbol}
        response = requests.get(url, params=params)
        response.raise_for_status()
        data = response.json()
        if "openInterest" in data:
            return float(data["openInterest"])
        else:
            st.error(f"æ— æ³•è·å–æŒä»“é‡: {data}")
            return None
    except Exception as e:
        st.error(f"è·å–æŒä»“é‡æ—¶å‡ºé”™: {e}")
        return None


# è·å–å†å²Kçº¿æ•°æ®
def get_historical_klines(symbol, interval, limit):
    try:
        # è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ï¼‰å’Œå¼€å§‹æ—¶é—´ï¼ˆ4å°æ—¶å‰ï¼‰
        end_time = int(datetime.now(timezone.utc).timestamp() * 1000)
        start_time = int((datetime.now(timezone.utc) - timedelta(hours=HOURS_TO_DISPLAY)).timestamp() * 1000)

        # è·å–ç°è´§å†å²æ•°æ®
        spot_url = "https://api.binance.com/api/v3/klines"
        spot_params = {
            "symbol": symbol,
            "interval": interval,
            "startTime": start_time,
            "endTime": end_time,
            "limit": limit
        }
        spot_response = requests.get(spot_url, params=spot_params)
        spot_response.raise_for_status()
        spot_data = spot_response.json()

        # è·å–æœŸè´§å†å²æ•°æ®
        futures_url = "https://fapi.binance.com/fapi/v1/klines"
        futures_params = {
            "symbol": symbol,
            "interval": interval,
            "startTime": start_time,
            "endTime": end_time,
            "limit": limit
        }
        futures_response = requests.get(futures_url, params=futures_params)
        futures_response.raise_for_status()
        futures_data = futures_response.json()

        # å¤„ç†æ•°æ®
        historical_timestamps = []
        historical_spot_prices = []
        historical_futures_prices = []
        historical_premiums = []

        # ç¡®ä¿ä¸¤ä¸ªæ•°æ®é›†é•¿åº¦ç›¸åŒ
        min_length = min(len(spot_data), len(futures_data))

        for i in range(min_length):
            timestamp = datetime.fromtimestamp(spot_data[i][0] / 1000, tz=timezone.utc)
            spot_close = float(spot_data[i][4])
            futures_close = float(futures_data[i][4])
            premium = (futures_close - spot_close) / spot_close * 100

            historical_timestamps.append(timestamp)
            historical_spot_prices.append(spot_close)
            historical_futures_prices.append(futures_close)
            historical_premiums.append(premium)

        return historical_timestamps, historical_spot_prices, historical_futures_prices, historical_premiums
    except Exception as e:
        st.error(f"è·å–å†å²Kçº¿æ•°æ®æ—¶å‡ºé”™: {e}")
        return [], [], [], []


# è·å–å†å²èµ„é‡‘è´¹ç‡æ•°æ®
def get_historical_funding_rates(symbol, limit=MAX_DATA_POINTS):
    try:
        # è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ï¼‰å’Œå¼€å§‹æ—¶é—´ï¼ˆ4å°æ—¶å‰ï¼‰
        end_time = int(datetime.now(timezone.utc).timestamp() * 1000)
        start_time = int((datetime.now(timezone.utc) - timedelta(hours=HOURS_TO_DISPLAY)).timestamp() * 1000)

        url = "https://fapi.binance.com/fapi/v1/fundingRate"
        params = {
            "symbol": symbol,
            "startTime": start_time,
            "endTime": end_time,
            "limit": limit
        }

        response = requests.get(url, params=params)
        response.raise_for_status()
        data = response.json()

        timestamps = []
        funding_rates = []

        for item in data:
            timestamps.append(datetime.fromtimestamp(item["fundingTime"] / 1000, tz=timezone.utc))
            funding_rates.append(float(item["fundingRate"]) * 100)  # è½¬æ¢ä¸ºç™¾åˆ†æ¯”

        return timestamps, funding_rates
    except Exception as e:
        st.error(f"è·å–å†å²èµ„é‡‘è´¹ç‡æ•°æ®æ—¶å‡ºé”™: {e}")
        return [], []


# è·å–å†å²æŒä»“é‡æ•°æ®
def get_historical_open_interest(symbol, period="5m", limit=MAX_DATA_POINTS):
    try:
        # è®¡ç®—ç»“æŸæ—¶é—´ï¼ˆå½“å‰æ—¶é—´ï¼‰å’Œå¼€å§‹æ—¶é—´ï¼ˆ4å°æ—¶å‰ï¼‰
        end_time = int(datetime.now(timezone.utc).timestamp() * 1000)
        start_time = int((datetime.now(timezone.utc) - timedelta(hours=HOURS_TO_DISPLAY)).timestamp() * 1000)

        url = "https://fapi.binance.com/futures/data/openInterestHist"
        params = {
            "symbol": symbol,
            "period": period,
            "startTime": start_time,
            "endTime": end_time,
            "limit": limit
        }

        response = requests.get(url, params=params)
        response.raise_for_status()
        data = response.json()

        timestamps = []
        open_interests = []

        for item in data:
            timestamps.append(datetime.fromtimestamp(item["timestamp"] / 1000, tz=timezone.utc))
            open_interests.append(float(item["sumOpenInterest"]))

        return timestamps, open_interests
    except Exception as e:
        st.error(f"è·å–å†å²æŒä»“é‡æ•°æ®æ—¶å‡ºé”™: {e}")
        return [], []


# æ›´æ–°æ•°æ®
def update_data(symbol):
    # è·å–å½“å‰æ—¶é—´
    now = datetime.now(timezone.utc)

    # è·å–ä»·æ ¼ã€èµ„é‡‘è´¹ç‡å’ŒæŒä»“é‡
    spot_price = get_spot_price(symbol)
    futures_price = get_futures_price(symbol)
    funding_rate = get_funding_rate(symbol)
    open_interest = get_open_interest(symbol)

    # å¦‚æœä»·æ ¼æ•°æ®å¯ç”¨ï¼Œåˆ™æ›´æ–°æ•°æ®
    if spot_price is not None and futures_price is not None:
        # è®¡ç®—æº¢ä»·ç‡
        premium = (futures_price - spot_price) / spot_price * 100

        # æ·»åŠ æ•°æ®åˆ°åˆ—è¡¨
        st.session_state.timestamps.append(now)
        st.session_state.spot_prices.append(spot_price)
        st.session_state.futures_prices.append(futures_price)
        st.session_state.premiums.append(premium)

        # å¦‚æœèµ„é‡‘è´¹ç‡å¯ç”¨ï¼Œåˆ™æ›´æ–°
        if funding_rate is not None:
            st.session_state.funding_rates.append(funding_rate * 100)  # è½¬æ¢ä¸ºç™¾åˆ†æ¯”
            st.session_state.last_funding_rate = funding_rate
        elif st.session_state.funding_rates:  # å¦‚æœæœ‰å†å²æ•°æ®ï¼Œåˆ™ä½¿ç”¨æœ€åä¸€ä¸ªå€¼
            st.session_state.funding_rates.append(st.session_state.funding_rates[-1])
        else:
            st.session_state.funding_rates.append(0)

        # å¦‚æœæŒä»“é‡å¯ç”¨ï¼Œåˆ™æ›´æ–°
        if open_interest is not None:
            st.session_state.open_interest.append(open_interest)
        elif st.session_state.open_interest:  # å¦‚æœæœ‰å†å²æ•°æ®ï¼Œåˆ™ä½¿ç”¨æœ€åä¸€ä¸ªå€¼
            st.session_state.open_interest.append(st.session_state.open_interest[-1])
        else:
            st.session_state.open_interest.append(0)

        # æ¸…ç†è¿‡æœŸæ•°æ® - åªä¿ç•™è¿‡å»4å°æ—¶çš„æ•°æ®
        # ä½†ç¡®ä¿ä¸ä¼šå› ä¸ºå†å²æ•°æ®ä¸è¶³è€Œå¯¼è‡´æ•°æ®å‡å°‘
        if len(st.session_state.timestamps) > 1:  # ç¡®ä¿è‡³å°‘æœ‰æ•°æ®
            cutoff_time = now - timedelta(hours=HOURS_TO_DISPLAY)

            # æ£€æŸ¥æœ€æ—©çš„æ—¶é—´æˆ³æ˜¯å¦å·²ç»åœ¨4å°æ—¶å†…
            # å¦‚æœæ˜¯ï¼Œåˆ™ä¸éœ€è¦æ¸…ç†ï¼Œè®©æ•°æ®è‡ªç„¶ç´¯ç§¯åˆ°4å°æ—¶
            if st.session_state.timestamps[0] < cutoff_time:
                # æ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸å°äºcutoff_timeçš„æ—¶é—´æˆ³çš„ç´¢å¼•
                valid_indices = [i for i, ts in enumerate(st.session_state.timestamps) if ts >= cutoff_time]
                if valid_indices:
                    start_idx = valid_indices[0]
                    st.session_state.timestamps = st.session_state.timestamps[start_idx:]
                    st.session_state.spot_prices = st.session_state.spot_prices[start_idx:]
                    st.session_state.futures_prices = st.session_state.futures_prices[start_idx:]
                    st.session_state.premiums = st.session_state.premiums[start_idx:]
                    st.session_state.funding_rates = st.session_state.funding_rates[start_idx:]
                    st.session_state.open_interest = st.session_state.open_interest[start_idx:]

        return spot_price, futures_price, premium, funding_rate, open_interest

    return None, None, None, funding_rate, open_interest


# åˆ›å»ºæº¢ä»·ç‡å›¾è¡¨
def create_premium_chart():
    if not st.session_state.timestamps:
        return None

    fig = go.Figure()

    # æ·»åŠ æº¢ä»·ç‡çº¿
    fig.add_trace(
        go.Scatter(
            x=st.session_state.timestamps,
            y=st.session_state.premiums,
            mode='lines',
            name='æœŸç°æº¢ä»·ç‡ (%)',
            line=dict(color='green')
        )
    )

    # æ›´æ–°å¸ƒå±€
    fig.update_layout(
        height=300,
        title_text=f"{st.session_state.symbol} æœŸç°æº¢ä»·ç‡ (%)",
        margin=dict(l=40, r=40, t=50, b=30),
        xaxis_title="æ—¶é—´ (UTC)",
        yaxis_title="æœŸç°æº¢ä»·ç‡ (%)",
        xaxis=dict(
            range=[
                datetime.now(timezone.utc) - timedelta(hours=HOURS_TO_DISPLAY),
                datetime.now(timezone.utc)
            ]
        )
    )

    # æ·»åŠ é›¶çº¿
    fig.add_hline(y=0, line_dash="dot", line_color="gray")

    return fig


# åˆ›å»ºèµ„é‡‘è´¹ç‡å›¾è¡¨
def create_funding_rate_chart():
    if not st.session_state.timestamps:
        return None

    fig = go.Figure()

    # æ·»åŠ èµ„é‡‘è´¹ç‡çº¿
    fig.add_trace(
        go.Scatter(
            x=st.session_state.timestamps,
            y=st.session_state.funding_rates,
            mode='lines',
            name='èµ„é‡‘è´¹ç‡ (%)',
            line=dict(color='red')
        )
    )

    # æ›´æ–°å¸ƒå±€
    fig.update_layout(
        height=300,
        title_text=f"{st.session_state.symbol} èµ„é‡‘è´¹ç‡ (%)",
        margin=dict(l=40, r=40, t=50, b=30),
        xaxis_title="æ—¶é—´ (UTC)",
        yaxis_title="èµ„é‡‘è´¹ç‡ (%)",
        xaxis=dict(
            range=[
                datetime.now(timezone.utc) - timedelta(hours=HOURS_TO_DISPLAY),
                datetime.now(timezone.utc)
            ]
        )
    )

    # æ·»åŠ é›¶çº¿
    fig.add_hline(y=0, line_dash="dot", line_color="gray")

    return fig


# åˆ›å»ºæŒä»“é‡å›¾è¡¨
def create_open_interest_chart():
    if not st.session_state.timestamps:
        return None

    fig = go.Figure()

    # æ·»åŠ æŒä»“é‡çº¿
    fig.add_trace(
        go.Scatter(
            x=st.session_state.timestamps,
            y=st.session_state.open_interest,
            mode='lines',
            name='æŒä»“é‡',
            line=dict(color='blue')
        )
    )

    # æ›´æ–°å¸ƒå±€
    fig.update_layout(
        height=300,
        title_text=f"{st.session_state.symbol} æŒä»“é‡",
        margin=dict(l=40, r=40, t=50, b=30),
        xaxis_title="æ—¶é—´ (UTC)",
        yaxis_title="æŒä»“é‡",
        xaxis=dict(
            range=[
                datetime.now(timezone.utc) - timedelta(hours=HOURS_TO_DISPLAY),
                datetime.now(timezone.utc)
            ]
        )
    )

    return fig


# åŠ è½½å†å²æ•°æ®
def load_historical_data(symbol):
    if not st.session_state.historical_data_loaded:
        with st.spinner("æ­£åœ¨åŠ è½½å†å²æ•°æ®..."):
            # è·å–è¿‡å»4å°æ—¶çš„1åˆ†é’ŸKçº¿æ•°æ®
            timestamps, spot_prices, futures_prices, premiums = get_historical_klines(
                symbol, "1m", MAX_DATA_POINTS
            )

            # è·å–å†å²èµ„é‡‘è´¹ç‡æ•°æ®
            funding_timestamps, funding_rates = get_historical_funding_rates(symbol)

            # è·å–å†å²æŒä»“é‡æ•°æ®
            oi_timestamps, open_interests = get_historical_open_interest(symbol)

            if timestamps:
                st.session_state.timestamps = timestamps
                st.session_state.spot_prices = spot_prices
                st.session_state.futures_prices = futures_prices
                st.session_state.premiums = premiums

                # åˆå§‹åŒ–èµ„é‡‘è´¹ç‡åˆ—è¡¨
                if funding_rates:
                    # å°†èµ„é‡‘è´¹ç‡æ•°æ®æ˜ å°„åˆ°æ—¶é—´æˆ³ä¸Š
                    mapped_funding_rates = []
                    for ts in timestamps:
                        # æ‰¾åˆ°æœ€æ¥è¿‘çš„èµ„é‡‘è´¹ç‡æ—¶é—´æˆ³
                        closest_idx = 0
                        min_diff = float('inf')
                        for i, fts in enumerate(funding_timestamps):
                            diff = abs((ts - fts).total_seconds())
                            if diff < min_diff:
                                min_diff = diff
                                closest_idx = i

                        # ä½¿ç”¨æœ€æ¥è¿‘æ—¶é—´çš„èµ„é‡‘è´¹ç‡
                        if closest_idx < len(funding_rates):
                            mapped_funding_rates.append(funding_rates[closest_idx])
                        else:
                            mapped_funding_rates.append(0)

                    st.session_state.funding_rates = mapped_funding_rates
                else:
                    st.session_state.funding_rates = [0] * len(timestamps)

                # åˆå§‹åŒ–æŒä»“é‡åˆ—è¡¨
                if open_interests:
                    # å°†æŒä»“é‡æ•°æ®æ˜ å°„åˆ°æ—¶é—´æˆ³ä¸Š
                    mapped_open_interests = []
                    for ts in timestamps:
                        # æ‰¾åˆ°æœ€æ¥è¿‘çš„æŒä»“é‡æ—¶é—´æˆ³
                        closest_idx = 0
                        min_diff = float('inf')
                        for i, ots in enumerate(oi_timestamps):
                            diff = abs((ts - ots).total_seconds())
                            if diff < min_diff:
                                min_diff = diff
                                closest_idx = i

                        # ä½¿ç”¨æœ€æ¥è¿‘æ—¶é—´çš„æŒä»“é‡
                        if closest_idx < len(open_interests):
                            mapped_open_interests.append(open_interests[closest_idx])
                        else:
                            mapped_open_interests.append(0)

                    st.session_state.open_interest = mapped_open_interests
                else:
                    st.session_state.open_interest = [0] * len(timestamps)

                # è·å–å½“å‰èµ„é‡‘è´¹ç‡å’ŒæŒä»“é‡
                funding_rate = get_funding_rate(symbol)
                open_interest = get_open_interest(symbol)

                if funding_rate is not None:
                    st.session_state.last_funding_rate = funding_rate
                    if st.session_state.funding_rates:
                        st.session_state.funding_rates[-1] = funding_rate * 100

                if open_interest is not None and st.session_state.open_interest:
                    st.session_state.open_interest[-1] = open_interest

                st.session_state.historical_data_loaded = True
                return True

            return False
    return True


def display_stats_data():
    # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°æ•°æ®ï¼ˆæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼‰
    if (st.session_state.last_stats_update is None or
            (datetime.now() - st.session_state.last_stats_update).total_seconds() > 60):
        load_stats_data()

    if st.session_state.stats_data:
        data = st.session_state.stats_data
        timestamp = data.get("timestamp", "æœªçŸ¥")

        # åˆ›å»ºå››åˆ—å¸ƒå±€
        col1, col2, col3, col4 = st.columns(4)

        # 1. è´¹ç‡æœ€é«˜çš„äº¤æ˜“å¯¹
        with col1:
            st.subheader("è´¹ç‡æœ€é«˜çš„äº¤æ˜“å¯¹")
            if "highest_rates" in data and data["highest_rates"]:
                df_highest = pd.DataFrame([
                    {"äº¤æ˜“å¯¹": item.get("symbol", ""),
                     "è´¹ç‡": f"{item.get('rate', 0) * 100:.2f}%"}
                    for item in data["highest_rates"]
                ])
                st.dataframe(df_highest, hide_index=True)
            else:
                st.write("æš‚æ— æ•°æ®")

        # 2. è´¹ç‡æœ€ä½çš„äº¤æ˜“å¯¹
        with col2:
            st.subheader("è´¹ç‡æœ€ä½çš„äº¤æ˜“å¯¹")
            if "lowest_rates" in data and data["lowest_rates"]:
                df_lowest = pd.DataFrame([
                    {"äº¤æ˜“å¯¹": item.get("symbol", ""),
                     "è´¹ç‡": f"{item.get('rate', 0) * 100:.2f}%"}
                    for item in data["lowest_rates"]
                ])
                st.dataframe(df_lowest, hide_index=True)
            else:
                st.write("æš‚æ— æ•°æ®")

        # 3. è´¹ç‡å¢é•¿æœ€å¤§çš„äº¤æ˜“å¯¹
        with col3:
            st.subheader("è´¹ç‡ä¸Šå‡æœ€å¿«")
            if "biggest_increases" in data and data["biggest_increases"]:
                df_increases = pd.DataFrame([
                    {"äº¤æ˜“å¯¹": item.get("symbol", ""),
                     "å˜åŒ–": f"{item.get('change', 0) * 100:.4f}%"}
                    for item in data["biggest_increases"]
                ])
                st.dataframe(df_increases, hide_index=True)
            else:
                st.write("æš‚æ— æ•°æ®")

        # 4. è´¹ç‡ä¸‹é™æœ€å¤§çš„äº¤æ˜“å¯¹
        with col4:
            st.subheader("è´¹ç‡ä¸‹é™æœ€å¿«")
            if "biggest_decreases" in data and data["biggest_decreases"]:
                df_decreases = pd.DataFrame([
                    {"äº¤æ˜“å¯¹": item.get("symbol", ""),
                     "å˜åŒ–": f"{item.get('change', 0) * 100:.4f}%"}
                    for item in data["biggest_decreases"]
                ])
                st.dataframe(df_decreases, hide_index=True)
            else:
                st.write("æš‚æ— æ•°æ®")

        # æ˜¾ç¤ºæ›´æ–°æ—¶é—´
        st.caption(f"æ›´æ–°æ—¶é—´: {timestamp}")
    else:
        st.error("æœªèƒ½åŠ è½½æ•°æ®ï¼Œè¯·æ£€æŸ¥APIè¿æ¥")


# ä¾§è¾¹æ æ§ä»¶
with st.sidebar:
    st.title("ç›‘æ§è®¾ç½®")

    new_symbol = st.text_input(
        "è¾“å…¥äº¤æ˜“å¯¹",
        value=st.session_state.symbol,
        placeholder="ä¾‹å¦‚: BTCUSDT, ETHUSDT"
    )

    if new_symbol != st.session_state.symbol:
        st.session_state.symbol = new_symbol
        # é‡ç½®æ•°æ®
        st.session_state.timestamps = []
        st.session_state.spot_prices = []
        st.session_state.futures_prices = []
        st.session_state.premiums = []
        st.session_state.funding_rates = []
        st.session_state.open_interest = []
        st.session_state.last_funding_rate = None
        st.session_state.historical_data_loaded = False
        st.session_state.charts = [None, None, None]
        if st.session_state.running:
            st.session_state.running = False
        st.rerun()

    col1, col2 = st.columns(2)

    with col1:
        start_stop = st.button('å¼€å§‹ç›‘æ§' if not st.session_state.running else 'åœæ­¢ç›‘æ§', use_container_width=True)
        if start_stop:
            st.session_state.running = not st.session_state.running
            if st.session_state.running:
                # åŠ è½½å†å²æ•°æ®
                success = load_historical_data(st.session_state.symbol)
                if not success:
                    st.error("æ— æ³•åŠ è½½å†å²æ•°æ®ï¼Œè¯·æ£€æŸ¥äº¤æ˜“å¯¹æ˜¯å¦æ­£ç¡®")
                    st.session_state.running = False
                st.rerun()

    with col2:
        if st.button('æ¸…é™¤æ•°æ®', use_container_width=True):
            st.session_state.timestamps = []
            st.session_state.spot_prices = []
            st.session_state.futures_prices = []
            st.session_state.premiums = []
            st.session_state.funding_rates = []
            st.session_state.open_interest = []
            st.session_state.last_funding_rate = None
            st.session_state.historical_data_loaded = False
            st.session_state.charts = [None, None, None]
            st.rerun()

# ä¸»é¡µé¢æ ‡é¢˜
st.title("åŠ å¯†è´§å¸æœŸç°æº¢ä»·ç›‘æ§")

display_stats_data()

# åˆ›å»ºå›ºå®šå®¹å™¨ - åªç”¨äºæ˜¾ç¤ºæœ€æ–°æ•°æ®
metrics_placeholder = st.empty()

# åˆ›å»ºä¸‰åˆ—å¸ƒå±€ç”¨äºå›¾è¡¨
chart_col1, chart_col2, chart_col3 = st.columns(3)

# ä¸»å¾ªç¯
if st.session_state.running:
    # åˆ›å»ºä¸€ä¸ªè¿›åº¦æ¡å ä½ç¬¦
    progress_placeholder = st.empty()

    # å¦‚æœå†å²æ•°æ®æœªåŠ è½½ï¼Œå…ˆåŠ è½½å†å²æ•°æ®
    if not st.session_state.historical_data_loaded:
        success = load_historical_data(st.session_state.symbol)
        if not success:
            st.error("æ— æ³•åŠ è½½å†å²æ•°æ®ï¼Œè¯·æ£€æŸ¥äº¤æ˜“å¯¹æ˜¯å¦æ­£ç¡®")
            st.session_state.running = False
            st.rerun()

    # åˆ›å»ºå›¾è¡¨å ä½ç¬¦ï¼ˆåªåˆ›å»ºä¸€æ¬¡ï¼‰
    if st.session_state.charts[0] is None:
        with chart_col1:
            st.session_state.charts[0] = st.empty()
    if st.session_state.charts[1] is None:
        with chart_col2:
            st.session_state.charts[1] = st.empty()
    if st.session_state.charts[2] is None:
        with chart_col3:
            st.session_state.charts[2] = st.empty()

    while st.session_state.running:
        # æ›´æ–°æ•°æ®
        spot_price, futures_price, premium, funding_rate, open_interest = update_data(st.session_state.symbol)



        # ä½¿ç”¨å•ä¸ªå ä½ç¬¦æ˜¾ç¤ºæœ€æ–°æŒ‡æ ‡
        if spot_price is not None and futures_price is not None:
            # è·å–UTCæ—¶é—´å¹¶æ ¼å¼åŒ–
            current_time = datetime.now(timezone.utc).strftime("%Y-%m-%d %H:%M:%S UTC")

            metrics_placeholder.markdown(f"""
            ### å½“å‰æ•°æ® - {st.session_state.symbol} ({current_time})
            | ç°è´§ä»·æ ¼ | æœŸè´§ä»·æ ¼ | æœŸç°æº¢ä»· | èµ„é‡‘è´¹ç‡ | æŒä»“é‡ |
            | --- | --- | --- | --- | --- |
            | {spot_price:.6f} | {futures_price:.6f} | {premium:.4f}% | {funding_rate * 100:.6f}% | {open_interest:.2f} |
            """)

        # æ›´æ–°å›¾è¡¨
        premium_fig = create_premium_chart()
        funding_fig = create_funding_rate_chart()
        open_interest_fig = create_open_interest_chart()

        if premium_fig and st.session_state.charts[0] is not None:
            st.session_state.charts[0].plotly_chart(premium_fig, use_container_width=True)
        if funding_fig and st.session_state.charts[1] is not None:
            st.session_state.charts[1].plotly_chart(funding_fig, use_container_width=True)
        if open_interest_fig and st.session_state.charts[2] is not None:
            st.session_state.charts[2].plotly_chart(open_interest_fig, use_container_width=True)

        # æ·»åŠ å€’è®¡æ—¶è¿›åº¦æ¡
        for i in range(UPDATE_INTERVAL, 0, -1):
            progress_placeholder.progress(1 - i / UPDATE_INTERVAL, text=f"ä¸‹æ¬¡æ›´æ–°å€’è®¡æ—¶: {i}ç§’")
            time.sleep(1)
else:


    st.info(f"ç‚¹å‡»ä¾§è¾¹æ ä¸­çš„'å¼€å§‹ç›‘æ§'æŒ‰é’®å¼€å§‹å®æ—¶ç›‘æ§ {st.session_state.symbol}")

    # å¦‚æœæœ‰å†å²æ•°æ®ï¼Œæ˜¾ç¤ºæœ€åçš„å›¾è¡¨
    if st.session_state.timestamps:
        with chart_col1:
            premium_fig = create_premium_chart()
            if premium_fig:
                st.plotly_chart(premium_fig, use_container_width=True)

        with chart_col2:
            funding_fig = create_funding_rate_chart()
            if funding_fig:
                st.plotly_chart(funding_fig, use_container_width=True)

        with chart_col3:
            open_interest_fig = create_open_interest_chart()
            if open_interest_fig:
                st.plotly_chart(open_interest_fig, use_container_width=True)
